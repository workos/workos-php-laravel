#!/bin/bash

KEY="composer-laravel-${1}-$(checksum composer.json)"

echo "Get that cache"
cache restore $KEY

echo -n "Setting desired Laravel version to "
case ${1} in
  "10")
    echo "10"
    laravel_version="^10.0.0"
    echo "install composer"
    if [[ ! `command -v composer 2>/dev/null` ]]
    then
      php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
      php composer-setup.php
      php -r "unlink('composer-setup.php');"
      php composer.phar require laravel/framework=${laravel_version}
      php composer.phar update --no-scripts
    else
      composer u
    fi
      ;;
  "11")
    echo "11"
    laravel_version="^11.0.0"
    echo "install composer"
    if [[ ! `command -v composer 2>/dev/null` ]]
    then
      php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
      php composer-setup.php
      php -r "unlink('composer-setup.php');"
      php composer.phar require laravel/framework=${laravel_version}
      php composer.phar update --no-scripts
    else
      composer u
    fi
      ;;
  "12")
    echo "12"
    laravel_version="^12.0.0"
    echo "install composer"
    if [[ ! `command -v composer 2>/dev/null` ]]
    then
      php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
      php composer-setup.php
      php -r "unlink('composer-setup.php');"
      php composer.phar require laravel/framework=${laravel_version}
      php composer.phar update --no-scripts
    else
      composer u
    fi
      ;;

  *)
    printf "\nError: Specify 10, 11, or 12 for Laravel version\n"
    exit 1
    ;;
esac

echo "Attempt to store cache in case of an initial miss"
cache store $KEY ./vendor

